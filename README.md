# Конфигурация mihomo для Keenetic (XKeen) с автоматическим Failover

> [!IMPORTANT]
> Данные конфигурационные файлы адаптированы для работы на маршрутизаторах **Keenetic** с установленным **XKeen** и ядром **mihomo**.

Это готовые к использованию конфигурационные файлы для ядра [mihomo](https://github.com/MetaCubeX/mihomo), оптимизированные для пользователей в России. Они реализуют подход **«проксируй всё, кроме RU»**: по умолчанию весь трафик направляется через прокси, а трафик к российским ресурсам и компаниям — напрямую (`DIRECT`).

Основная цель — обеспечить стабильное, быстрое и бесшовное соединение, автоматически переключаясь между прокси и прямым подключением при сбоях.

![image](https://github.com/user-attachments/assets/c39053f9-96a6-4e82-90fb-b3e0c1fdaf97)

## Основные возможности

*   **Два способа подключения**:
    1.  Через **ссылку-подписку** (`config-fallback-sub.yml`).
    2.  Через **статические VLESS-ключи** (`config-fallback-keys.yml`).
*   **Полностью автоматический режим работы с отказоустойчивостью (Failover)**.
    *   Сначала используется самый быстрый прокси.
    *   При его отказе — перебор всех остальных живых прокси.
    *   И только если все серверы недоступны, происходит переключение на прямое соединение (`DIRECT`).
    *   Автоматическое восстановление на самый быстрый прокси, как только он снова становится доступен.
*   **Требуется как минимум 3 сервера (ключа)** для корректной работы логики отказоустойчивости.
*   **«Установил и забыл»**: Вам не нужно постоянно обновлять списки правил каждый раз, когда блокируют очередной иностранный сервис или вводятся новые ограничения со стороны РФ. Конфигурация изначально настроена на обход блокировок для всего зарубежного трафика, а российский сегмент работает напрямую без лишних задержек.
*   **Актуальные наборы правил**: используются популярные списки для блокировки рекламы (OISD) и маршрутизации трафика для российского сегмента.

### Логика работы автоматического режима (`ProxyAuto`)

Конфигурация использует многоуровневую систему для максимальной надежности:

1.  Попытка использовать самый быстрый прокси из группы **`ProxyFastest`** (`url-test`).
2.  ➡️ В случае сбоя: переключение на группу **`ProxyFailover`** (`fallback`), которая последовательно перебирает все остальные доступные прокси.
3.  ➡️ В случае сбоя всех прокси: переключение на **`DIRECT`**.
4.  ➡️ При восстановлении прокси предыдущих групп, переключение с **`DIRECT`** на **`ProxyFailover`** (`fallback`) и **`ProxyFastest`** (`url-test`)

Эта схема гарантирует, что вы останетесь онлайн, пока работает хотя бы один прокси или есть прямое подключение к интернету.

## Какой файл выбрать?

*   `config-fallback-sub.yml` — **Для тех, у кого есть ссылка на подписку.** Это самый простой вариант.
*   `config-fallback-keys.yml` — **Для тех, у кого есть собственные VLESS-ключи.** Требует ручного ввода данных ваших серверов.

## Быстрый старт

### Вариант 1: Использование подписки (`config-fallback-sub.yml`)

1.  Скачайте файл `config-fallback-sub.yml`.
2.  Откройте файл в текстовом редакторе.
3.  Найдите секцию `proxy-providers` и вставьте URL вашей прокси-подписки в поле `url`.

    ```yaml
    proxy-providers:
      subscription:
        type: http
        # Вставьте вашу ссылку сюда
        url: https://your_sub_domain/sub
        # ...
    ```
4.  Переименуйте `config-fallback-sub.yml` в `config.yml`, переместите его в рабочую директорию `/opt/etc/mihomo/` и запустите ядро.

### Вариант 2: Использование VLESS-ключей (`config-fallback-keys.yml`)

1.  Скачайте файл `config-fallback-keys.yml`.
2.  Откройте файл в текстовом редакторе.
3.  Найдите секцию `proxies` и **внимательно заполните данные для ваших трёх (или более) серверов**: `server`, `port`, `uuid`, `servername`.

    ```yaml
    proxies:
      - name: "VLESS-1"
        type: vless
        server: server1.yourdomain.com  # IP-адрес или домен вашего сервера
        port: 443
        uuid: "00000000-0000-0000-0000-000000000001" # Ваш UUID
        tls: true
        servername: server1.yourdomain.com # Ваш домен (SNI)
        udp: true
      # ... и так далее для VLESS-2, VLESS-3 ...
    ```
4.  (Опционально, но рекомендуется) В секции `rules` добавьте домены ваших серверов в исключения, чтобы подключение к ним всегда шло напрямую.
    ```yaml
    rules:
      # ...
      - DOMAIN-SUFFIX,server1.yourdomain.com,DIRECT
      - DOMAIN-SUFFIX,server2.yourdomain.com,DIRECT
      - DOMAIN-SUFFIX,server3.yourdomain.com,DIRECT
      # ...
    ```
5.  Переименуйте `config-fallback-keys.yml` в `config.yml`, переместите его в рабочую директорию `/opt/etc/mihomo/` и запустите ядро.

## Настройка под себя

*   **Правила маршрутизации** находятся в секции `rules`. Вы можете добавлять, изменять или удалять их в соответствии с вашими потребностями.
*   **Настройки проверки доступности прокси** (интервалы) можно изменить в секциях `proxy-providers` и `proxy-groups`.

### Важно: Настройка портов

По умолчанию, правила маршрутизации в этой конфигурации рассчитаны на стандартный веб-трафик (порты 80/443). Весь остальной трафик также пойдет через прокси.

Если вы испытываете проблемы с задержками (пингом) в онлайн-играх или других приложениях, которые используют иные порты, вы можете добавить их в исключения, чтобы трафик для них шел напрямую. Для этого добавьте в начало секции `rules` следующие правила:

```yaml
  # Пример добавления портов в исключения для прямого подключения (DIRECT).
  # Это помогает снизить пинг в играх и улучшить работу специфичных приложений,
  # направляя их трафик мимо прокси.
  - DST-PORT,444-6880,DIRECT
  - DST-PORT,6881-49999,DIRECT
  - DST-PORT,50031-65535,DIRECT
```

## Отказ от ответственности

Конфигурация предоставляется "как есть". Автор не несет ответственности за возможные проблемы, связанные с ее использованием. Используйте на свой страх и риск.